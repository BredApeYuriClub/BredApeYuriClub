<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketplace NFT</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.0.24/dist/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
        }
        .nft-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .nft-item {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            width: 200px;
            text-align: center;
            border-radius: 10px;
        }
        .nft-item img {
            max-width: 100%;
            border-radius: 10px;
        }
        .nft-item button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .nft-item button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>Welcome to NFT Marketplace</h1>
    
    <!-- Button to connect MetaMask -->
    <button id="connectButton">Connect to MetaMask</button>
    
    <!-- Account info section -->
    <div id="accountInfo" style="display:none;">
        <h3>Account:</h3>
        <p id="account"></p>
    </div>

    <!-- NFT List Section -->
    <h2>Available NFTs</h2>
    <div id="nftList" class="nft-list">
        <!-- NFTs will be displayed here -->
    </div>

    <script>
        // Initialize the provider and contract address
        const nftContractAddress = "0x85A9ab85c0E70780d9dd1676e0a9Aaff900a06fE";  // Your contract address
        const nftAbi = [
            "function tokenURI(uint256 tokenId) public view returns (string memory)",
            "function totalSupply() public view returns (uint256)",
            "function buyNFT(uint256 tokenId) public payable"
        ];

        let userAccount = null;

        // Check if MetaMask is installed
        if (typeof window.ethereum === 'undefined') {
            alert("MetaMask is not installed. Please install MetaMask to use this feature.");
        }

        // Set up the provider and signer
        const provider = new ethers.BrowserProvider(window.ethereum);
        const signer = provider.getSigner();
        const contract = new ethers.Contract(nftContractAddress, nftAbi, signer);

        // Function to connect MetaMask and display user account
        const connectButton = document.getElementById("connectButton");
        const accountInfo = document.getElementById("accountInfo");
        const accountParagraph = document.getElementById("account");

        connectButton.addEventListener("click", async () => {
            try {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                accountParagraph.textContent = userAccount;
                accountInfo.style.display = "block";
                connectButton.style.display = "none";
                fetchNFTs();  // Fetch NFTs after connecting
            } catch (error) {
                console.error("User rejected the connection request or an error occurred.");
            }
        });

        // Function to fetch NFTs and display them
        async function fetchNFTs() {
            try {
                const totalSupply = await contract.totalSupply();

                // Loop through all NFTs
                for (let tokenId = 1; tokenId <= totalSupply; tokenId++) {
                    const tokenURI = await contract.tokenURI(tokenId);
                    const metadata = await fetch(tokenURI).then(response => response.json());

                    // Create NFT item element
                    const nftElement = document.createElement("div");
                    nftElement.classList.add("nft-item");

                    const nftImage = document.createElement("img");
                    nftImage.src = metadata.image;  // URL of the NFT image
                    nftImage.alt = metadata.name;
                    nftImage.width = 150;

                    const nftName = document.createElement("h3");
                    nftName.textContent = metadata.name;

                    const nftDescription = document.createElement("p");
                    nftDescription.textContent = metadata.description;

                    const nftPrice = metadata.price || 0.1;  // Default price if not specified

                    const buyButton = document.createElement("button");
                    buyButton.textContent = `Buy for ${nftPrice} ETH`;
                    buyButton.onclick = function() {
                        buyNFT(tokenId, ethers.parseUnits(nftPrice.toString(), "ether"));
                    };

                    // Append elements to the page
                    nftElement.appendChild(nftImage);
                    nftElement.appendChild(nftName);
                    nftElement.appendChild(nftDescription);
                    nftElement.appendChild(buyButton);

                    document.getElementById("nftList").appendChild(nftElement);
                }
            } catch (error) {
                console.error("Error fetching NFTs:", error);
            }
        }

        // Function to buy NFT
        async function buyNFT(tokenId, price) {
            try {
                const tx = await contract.buyNFT(tokenId, { value: price });
                await tx.wait();
                alert("NFT successfully purchased!");
            } catch (error) {
                console.error("Error buying NFT:", error);
                alert("Failed to purchase NFT.");
            }
        }

    </script>
</body>
</html>
